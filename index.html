<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOUL PLUS | المحول الذكي</title>
    <style>
        :root { --primary: #00d2ff; --bg: #0f172a; --card: #1e293b; }
        body { background: var(--bg); color: white; font-family: -apple-system, sans-serif; text-align: center; margin: 0; padding: 20px; }
        .app-card { background: var(--card); padding: 15px; border-radius: 20px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; border: 1px solid #334155; }
        .app-icon { width: 50px; height: 50px; border-radius: 12px; margin-left: 10px; }
        .install-btn { background: linear-gradient(to right, #00d2ff, #3a7bd5); color: white; border: none; padding: 10px 20px; border-radius: 15px; font-weight: bold; cursor: pointer; }
        .search { width: 100%; padding: 12px; border-radius: 15px; border: none; margin-bottom: 20px; background: #334155; color: white; }
    </style>
</head>
<body>

    <h1 style="color: var(--primary);">SOUL PLUS</h1>
    <input type="text" id="search" class="search" placeholder="ابحث عن تطبيق..." oninput="search()">
    
    <div id="status" style="font-size: 12px; margin-bottom: 10px; color: #94a3b8;">جاري فحص المصادر...</div>
    <div id="list"></div>

<script>
    const sources = [
        "https://ipa.cypwn.xyz/cypwn.json",
        "https://wuxu1.github.io/wuxu-complete.json",
        "https://esign.yyyue.xyz/app.json",
        "https://raw.githubusercontent.com/swaggyP36000/TrollStore-IPAs/main/apps.json"
    ];

    let allApps = [];

    async function getApps() {
        for (let url of sources) {
            try {
                const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
                const data = await res.json();
                const json = JSON.parse(data.contents);
                const apps = json.apps || json.applications || [];
                apps.forEach(a => {
                    allApps.push({
                        name: a.name,
                        icon: a.iconUrl || a.icon,
                        url: a.downloadURL || a.ipaUrl || a.ipaURL,
                        bundle: a.bundleIdentifier || "com.soul.app"
                    });
                });
                render(allApps);
            } catch (e) { console.log("خطأ في مصدر"); }
        }
        document.getElementById('status').innerText = "✅ المتجر جاهز للاستخدام";
    }

    function render(apps) {
        const container = document.getElementById('list');
        container.innerHTML = apps.map(app => `
            <div class="app-card">
                <div style="display:flex; align-items:center;">
                    <img src="${app.icon}" class="app-icon" onerror="this.src='https://via.placeholder.com/100'">
                    <span style="font-weight:bold;">${app.name}</span>
                </div>
                <button class="install-btn" onclick="smartInstall('${app.url}', '${app.name}', '${app.bundle}')">تثبيت</button>
            </div>
        `).join('');
    }

    // الدالة السحرية: تحويل الـ IPA إلى Plist فوراً
    function smartInstall(url, name, bundle) {
        if (!url) return alert("الرابط غير صالح");

        // إذا كان الرابط IPA، نستخدم محول خارجي سريع وموثوق
        if (url.includes('.ipa')) {
            const plistGenerator = `https://api.isign.cloud/plist?url=${encodeURIComponent(url)}&name=${encodeURIComponent(name)}&bundle=${bundle}`;
            window.location.href = `itms-services://?action=download-manifest&url=${plistGenerator}`;
        } 
        // إذا كان Plist جاهز، نفتحه مباشرة
        else if (url.includes('.plist')) {
            window.location.href = `itms-services://?action=download-manifest&url=${url}`;
        }
        else {
            // إذا كان رابط صفحة، نفتحه
            window.open(url, '_blank');
        }
    }

    function search() {
        const query = document.getElementById('search').value.toLowerCase();
        const filtered = allApps.filter(a => a.name.toLowerCase().includes(query));
        render(filtered);
    }

    getApps();
</script>
</body>
</html>
